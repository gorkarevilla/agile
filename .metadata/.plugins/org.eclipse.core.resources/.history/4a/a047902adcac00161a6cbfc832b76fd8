from django.contrib import messages
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from django.contrib.auth.models import User
from django.contrib.comments.forms import CommentForm
from django.core.exceptions import ObjectDoesNotExist
from django.http import HttpResponse, HttpResponseRedirect, HttpResponseBadRequest
from django.shortcuts import render
from django.shortcuts import render, render_to_response
from django.template.context import RequestContext
from django.views.decorators.http import require_http_methods

from ideas.forms import IdeaForm

from .forms import LoginForm, UserRegistrationForm


# Create your views here.
@require_http_methods(["GET"])
def index(request):
	return render (request, 'ideas/index.html')

def user_login(request):
	if request.method == 'GET': 
		form = LoginForm()
		return render (request, 'ideas/login.html', {'form':form})
	if request.method == 'POST': 
		form = LoginForm(request.POST)

		if form.is_valid(): 
			cd = form.cleaned_data
			user = authenticate(username=cd['username'], password=cd['password'])
			
			if user is not None: 
				login(request,user)
				messages.add_message(request, messages.SUCCESS, 'You have sucessfully logged in!')
				return HttpResponseRedirect('/ideas/')
			else:
				messages.error(request, "Wrong user or password")
				return render(request, 'ideas/login.html', {'form':LoginForm})
		else: 
			messages.error(request, "Wrong user or password")
			return render(request, 'ideas/login.html', {'form':LoginForm})
	else: 
		return HttpResponse("I'm lost")

def user_signup(request): 
	if request.method == 'POST': 
		user_form = UserRegistrationForm(request.POST)
		if user_form.is_valid(): 
			new_user = user_form.save(commit=False)
			new_user.set_password(
				user_form.cleaned_data['password'])
			new_user.save()
			messages.add_message(request, messages.SUCCESS, 'User successfully created!')
			return HttpResponseRedirect('/ideas/')
	else: 
		user_form = UserRegistrationForm()
	return render(request,'ideas/signup.html', {'user_form':user_form})

def add_idea (request):
	if request.method == 'POST':
		idea_form = IdeaForm(request.POST)
		
	if idea_form.is_valid():
		cd = form.cleaned_data
		valida = authenticate(comment=cd['comment'], idea_id=cd['idea_id'])
		
	if valida is not None:
		comment = idea_form.save(commit=False)
		messages.add_message(request, messages.SUCCESS, 'You have sucessfully commented!')
		return HttpResponseRedirect('/ideas/')
		comment.save()
	else:
		return render_to_response('ideas/comments.html', {'comment_form': CommentForm,
														'allow_comments':True,
														}, context_instance=RequestContext(request))
		messages.error(request, "You don't have commented")
		
	else:
return HttpResponseRedirect(request.META.get('HTTP_REFERER', '/'))
		